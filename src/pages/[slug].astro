---
import type { MarkdownInstance, GetStaticPathsOptions } from "astro";
import Layout from "@/layouts/Layout.astro";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { parseISO, format } from "date-fns";
import { getCollection } from "astro:content";
import { render } from "astro:content";

export async function getStaticPaths({}: GetStaticPathsOptions) {
  const allContent = await getCollection("posts");
  const paths = allContent.map((post) => {
    const slug = getSlugFromPath(post.filePath ?? '');
    return {
      params: {
        slug: slug,
      },
      props: { post },
    };
  });

  return paths;
}

export const getSlugFromPath = (path: string): string => {
  return path.split("/").at(-1)!.replace(".md", "");
};

const { post } = Astro.props;

const { headings, Content } = await render(post);

const date: Date = parseISO(post.data.date);
const formatted: string = post.data.date == "<top>" ? "" : format(date, "LLLL d, yyyy");

const isProject =
  post.data.categories &&
  post.data.categories.includes("project");
---

<Layout title={post.data.title}>
  <article class="container mx-auto py-10 lg:px-52">
    {
      post.data.image && (
        <div>
          <img
            src={post.data.image}
            alt={post.data.title}
            class="w-full h-auto max-h-[400px] object-contain mx-auto"
          />
        </div>
      )
    }
    <main>
      <div class="text-xl">
            <a
              href={post.data.link ?? `/${getSlugFromPath(post.filePath ?? '')}`}
              target="_blank"
              rel="noopener noreferrer"
              class="!no-underline"
            >
              <h1>{post.data.title}</h1>
            </a>
        <h4>
          <time datetime={date.toString()}>{formatted}</time>

          {post.body && <span>ãƒ»<em>{`${post.body.split(" ").length} words`}</em></span>}
        </h4>
      </div>

      {
        isProject && post.data.link && (
          <div class="my-4">
            <a
              href={post.data.link}
              target="_blank"
              rel="noopener noreferrer"
            >
              <Button variant="outline">View Live Project / Tool</Button>
            </a>
          </div>
        )
      }

      {
        headings.length != 0 && (
          <div class="mt-3">
            <Card>
              <div class="-m-3 flex flex-col">
                <CardHeader>
                  <h6 class="-mb-5 -mt-1">Contents</h6>
                </CardHeader>
                <CardContent>
                  {headings.map((heading) => (
                    <div style={`margin-left: ${2 * heading.depth - 1}rem`}>
                      <a href={`#${heading.slug}`} class="text-sm">
                        {heading.text}
                      </a>
                    </div>
                  ))}
                </CardContent>
              </div>
            </Card>
          </div>
        )
      }

      <Content />
    </main>
  </article>
</Layout>
